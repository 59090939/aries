<!DOCTYPE html>
<!--
██╗      █████╗ ██████╗ ██████╗ ██╗   ██╗███████╗
██║     ██╔══██╗██╔══██╗██╔══██╗╚██╗ ██╔╝██╔════╝
██║     ███████║██████╔╝██████╔╝ ╚████╔╝ ███████╗
██║     ██╔══██║██╔══██╗██╔══██╗  ╚██╔╝  ╚════██║
███████╗██║  ██║██║  ██║██║  ██║   ██║   ███████║
╚══════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   ╚══════╝

 █████╗ ██████╗ ██╗███████╗███████╗
██╔══██╗██╔══██╗██║██╔════╝██╔════╝
███████║██████╔╝██║█████╗  ███████╗
██╔══██║██╔══██╗██║██╔══╝  ╚════██║
██║  ██║██║  ██║██║███████╗███████║
╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚══════╝╚══════╝

By Larry Xu and Michael Whittaker
-->
<html>
  <head>
    <title>ARIES</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://rawgit.com/jneen/parsimmon/master/src/parsimmon.js"></script>
    <script src="aries.js"></script>
    <link rel="stylesheet" href="normalize.css">
    <style>
      body {
        min-width: 900px;
      }

      header {
        padding: 10px 2.5%;
        background: antiquewhite;
      }

      .width-30 {
        width: 30%;
        margin: 0 1.25% 0 1.25%;
        float: left;
      }

      .width-30:first-of-type {
        margin-left: 2.5%;
      }

      .width-30:last-of-type {
        margin-right: 2.5%;
      }

      table {
        border-spacing: 0;
        border-collapse: collapse;
        width: 100%;
      }

      thead tr {
        background: bisque;
      }

      tr.new-row {
        background: lightgreen;
      }

      tr.updated-row {
        background: lightskyblue;
      }

      th, td {
        border: 1px solid black;
        padding: 3px;
      }

      td.updated-cell {
        background: deepskyblue;
      }
    </style>
  </head>
  <body>
    <header>
      <span>Controls:</span>
      <button id="left-arrow">&lt;</button>
      <button id="right-arrow">&gt;</button>
      <span>(or use left and right arrow keys)</span>
    </header>

    <div class="width-30">
      <div>
        <h2>Log</h2>
        <p>LSN of last log record flushed to disk: <span id="lsn-flushed"></span></p>
        <table id="log">
          <thead>
            <tr>
              <th>LSN</th>
              <th>Trans ID</th>
              <th>Type</th>
              <th>Page ID</th>
              <th>prevLSN</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>

    <div class="width-30">
      <div>
        <h2>Dirty Page Table</h2>
        <table id="dirty-page-table">
          <thead>
            <tr>
              <th>Page ID</th>
              <th>recLSN</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>

      <div>
        <h2>Transaction Table</h2>
        <table id="transaction-table">
          <thead>
            <tr>
              <th>Trans ID</th>
              <th>Status</th>
              <th>lastLSN</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>

    <div class="width-30">
      <div>
        <h2>Buffer Pool</h2>
        <table id="buffer-pool">
          <thead>
            <tr>
              <th>Page ID</th>
              <th>pageLSN</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>

      <div>
        <h2>Disk</h2>
        <table id="disk">
          <thead>
            <tr>
              <th>Page ID</th>
              <th>pageLSN</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>

    <script>

      // Mapping of DOM table id to data keys corresponding to table columns
      var column_keys = {
        'log': ['lsn', 'txn_id', 'type', 'page_id', 'prev_lsn'],
        'dirty-page-table': ['page_id', 'rec_lsn'],
        'transaction-table': ['txn_id', 'txn_status', 'last_lsn'],
        'buffer-pool': ['page_id', 'page_lsn', 'value'],
        'disk': ['page_id', 'page_lsn', 'value']
      };

      // Helper function to convert an object map to a list
      function mapToList(map, id_name) {
        var list = [];
        for (var key of Object.keys(map)) {
          var obj = {};
          obj[id_name] = key;
          for (var field of Object.keys(map[key])) {
            obj[field] = map[key][field];
          }
          list.push(obj);
        }
        return list;
      }

      // Given a DOM table id and data list/object, join the new data to the
      // DOM table using D3 joins
      function updateTable(table_id, data) {
        var columns = column_keys[table_id];
        var key = columns[0];
        if (!Array.isArray(data)) {
          data = mapToList(data, key);
        }

        var updated_rows = d3.select('table#' + table_id)
                             .select('tbody')
                             .selectAll('tr')
                             .data(data, function(d) {
                               return d ? d[key] : this.id;
                             })
                             .attr('class', '');

        updated_rows.exit().remove();

        var cells = updated_rows.selectAll('td')
                                .data(function(row) {
                                  return columns.map(function(column) {
                                    return row[column];
                                  });
                                })
                                .attr('class', function(d) {
                                  return (d !== this.__oldData__) ? 'updated-cell' : '';
                                })
                                .property('__oldData__', function(d) {
                                  if (d !== this.__oldData__) {
                                    d3.select(this.parentNode)
                                      .attr('class', 'updated-row');
                                  }
                                  return d;
                                })
                                .text(function(d) { return d; });

        var new_rows = updated_rows.enter()
                                   .append('tr')
                                   .attr('id', function(d) {
                                     return d[key]
                                   })
                                   .attr('class', 'new-row');

        new_rows.selectAll('td')
                .data(function(row) {
                  return columns.map(function(column) {
                    return row[column];
                  });
                })
                .enter()
                .append('td')
                .property('__oldData__', function(d) {
                  return d;
                })
                .text(function(d) { return d; });
      }

      // Given a DOM span id and datum value, assign the new datum value to the
      // DOM span using D3 data bindings
      function updateValue(span_id, datum) {
        d3.select('span#' + span_id)
          .datum(datum)
          .text(function(d) {
            if (d > -1) {
              return d;
            }
          });
      }

      // Given a new state, update the UI to reflect the state
      function onStateChanged(state) {
        updateTable('log', state.log);
        updateTable('dirty-page-table', state.dirty_page_table);
        updateTable('transaction-table', state.txn_table);
        updateTable('buffer-pool', state.buffer_pool);
        updateTable('disk', state.disk);
        updateValue('lsn-flushed', state.num_flushed - 1);
      }

      // TODO(larry): Parse operations from the UI.
      var input =
        "W_1(A, one)," + // new aries.Op.Write("1", "A", "one"),
        "W_2(B, two)," + // new aries.Op.Write("2", "B", "two"),
        "Flush(B)," + // new aries.Op.Flush("B"),
        "W_3(C, three)," + // new aries.Op.Write("3", "C", "three"),
        "Flush(C)," + // new aries.Op.Flush("C"),
        "Checkpoint()," + // new aries.Op.Checkpoint(),
        "W_2(D, four)," + // new aries.Op.Write("2", "D", "four"),
        "W_1(A, five)," + // new aries.Op.Write("1", "A", "five"),
        "Commit_1()," + // new aries.Op.Commit("1"),
        "W_3(C, six)," + // new aries.Op.Write("3", "C", "six"),
        "W_2(D, seven)," + // new aries.Op.Write("2", "D", "seven"),
        "Flush(D)," + // new aries.Op.Flush("D"),
        "W_2(B, eight)," + // new aries.Op.Write("2", "B", "eight"),
        "W_3(A, nine)";   // new aries.Op.Write("3", "A", "nine"),
      var ops_result = aries.Op.parse_ops(input);
      if (!ops_result.status) {
        console.assert(false, Parsimmon.formatError(input, ops_result));
      }
      var ops = ops_result.value;

      // Start the ARIES simulator.
      var states = aries.simulate(ops);
      var currStateIdx = 0;

      // Renders previous state
      function renderPrevState() {
        if (currStateIdx > 0) {
          onStateChanged(states[--currStateIdx]);
        }
      }

      // Renders next state
      function renderNextState() {
        if (currStateIdx < states.length - 1) {
          onStateChanged(states[++currStateIdx]);
        }
      }

      // Transition between states when left or right arrow keys are pressed
      document.addEventListener('keydown', function(event) {
        if (event.keyCode === 37) { // left arrow
          renderPrevState();
        } else if (event.keyCode === 39) { // right arrow
          renderNextState();
        }
      }, false);

      // Transition to previous state when left arrow button is clicked
      var left_arrow = document.getElementById('left-arrow');
      left_arrow.addEventListener('click', function(event) {
        renderPrevState();
      }, false);

      // Transition to next state when right arrow button is clicked
      var right_arrow = document.getElementById('right-arrow');
      right_arrow.addEventListener('click', function(event) {
        renderNextState();
      }, false);
    </script>
  </body>
</html>
